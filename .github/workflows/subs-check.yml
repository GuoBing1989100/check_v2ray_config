name: V2Ray Subscription Checker

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  check-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        
      - name: Verify configuration
        run: |
          echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
          if [ ! -f "config/config.yaml" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ config/config.yaml"
            exit 1
          fi
          
          # ç¡®ä¿è¾“å‡ºç›®å½•è®¾ç½®æ­£ç¡®
          sed -i 's|output-dir:.*|output-dir: "/app/output"|' config/config.yaml
          echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨å¹¶å·²æ›´æ–°è¾“å‡ºç›®å½•"
        
      - name: Setup environment
        run: |
          echo "ğŸ›  å‡†å¤‡ç¯å¢ƒ..."
          mkdir -p output
          chmod -R 777 output
          echo "å½“å‰ç›®å½•ç»“æ„:"
          ls -al
          
      - name: Run subscription checker (fixed parameter format)
        run: |
          echo "ğŸš€ å¼€å§‹æ£€æŸ¥è®¢é˜…èŠ‚ç‚¹ (å‚æ•°æ ¼å¼ä¿®å¤ç‰ˆ)..."
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # å°è¯•ä¸‰ç§å¯èƒ½çš„å‚æ•°æ ¼å¼
          echo "å°è¯•å‚æ•°æ ¼å¼: config /app/config/config.yaml"
          docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest \
            config /app/config/config.yaml || \
          (
            echo "æ ¼å¼1å¤±è´¥ï¼Œå°è¯•æ ¼å¼2: -config /app/config/config.yaml"
            docker run --rm \
              -v ${{ github.workspace }}/config:/app/config \
              -v ${{ github.workspace }}/output:/app/output \
              ghcr.io/jackrun123/subs-check:latest \
              -config /app/config/config.yaml || \
            (
              echo "æ ¼å¼2å¤±è´¥ï¼Œå°è¯•æ ¼å¼3: /app/config/config.yaml"
              docker run --rm \
                -v ${{ github.workspace }}/config:/app/config \
                -v ${{ github.workspace }}/output:/app/output \
                ghcr.io/jackrun123/subs-check:latest \
                /app/config/config.yaml
            )
          )
          
          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â± æ£€æŸ¥å®Œæˆ! è€—æ—¶: $DURATION ç§’"
          
          # ç¡®ä¿è¾“å‡ºæ–‡ä»¶å­˜åœ¨
          if [ ! -f output/all.txt ]; then
            echo "âš  è­¦å‘Š: all.txt æœªç”Ÿæˆï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            touch output/all.txt
          fi
          
          # æ˜¾ç¤ºèŠ‚ç‚¹ç»Ÿè®¡
          NODE_COUNT=$(wc -l < output/all.txt)
          echo "ğŸ“Š æœ‰æ•ˆèŠ‚ç‚¹æ•°é‡: $NODE_COUNT"
          
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          
      - name: Push results to target repository
        run: |
          echo "ğŸ“¤ æ¨é€ç»“æœåˆ°ç›®æ ‡ä»“åº“..."
          cp -v output/all.txt target-repo/all.txt
          
          cd target-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all.txt
          
          if git diff-index --quiet HEAD --; then
            echo "ğŸŸ¢ æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            NODE_COUNT=$(wc -l < all.txt)
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨ ($NODE_COUNT ä¸ªèŠ‚ç‚¹) $TIMESTAMP"
            git push
            echo "âœ… æäº¤æˆåŠŸ! æ¨é€äº† $NODE_COUNT ä¸ªèŠ‚ç‚¹"
          fi
          
      - name: Final verification
        run: |
          echo "ğŸ” æœ€ç»ˆéªŒè¯"
          if [ -f target-repo/all.txt ]; then
            NODE_COUNT=$(wc -l < target-repo/all.txt)
            echo "ğŸ“¦ æˆåŠŸæ¨é€ $NODE_COUNT ä¸ªèŠ‚ç‚¹"
            echo "å‰5ä¸ªèŠ‚ç‚¹é¢„è§ˆ:"
            head -n 5 target-repo/all.txt
          else
            echo "âŒ é”™è¯¯: all.txt æœªæ‰¾åˆ°"
          fi
          echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
