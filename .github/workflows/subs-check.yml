name: Subscription Cleaner

on:
  schedule:
    - cron: '0 */8 * * *'  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  filter-subscriptions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… Python ä¾èµ–
        run: pip install requests pyyaml

      - name: è¿è¡Œè¿‡æ»¤è„šæœ¬ï¼Œæ¸…é™¤ reality èŠ‚ç‚¹
        run: |
          cat << 'EOF' > filter_reality.py
          import requests
          import yaml

          urls = [
              "https://raw.githubusercontent.com/firefoxmmx2/v2rayshare_subcription/main/subscription/clash_sub.yaml",
              # ä½ å¯ä»¥ç»§ç»­æ·»åŠ è®¢é˜…é“¾æ¥ â†“â†“â†“
              "https://raw.githubusercontent.com/mahdibland/ShadowsocksAggregator/master/Eternity.yml",
              "https://raw.githubusercontent.com/ermaozi/get_subscribe/main/subscribe/clash.yml"
          ]

          def download_yaml(url):
              try:
                  print(f"ğŸ“¥ ä¸‹è½½ï¼š{url}")
                  r = requests.get(url, timeout=10)
                  return yaml.safe_load(r.text)
              except Exception as e:
                  print(f"âŒ é”™è¯¯ï¼š{url} -> {e}")
                  return {}

          def filter_proxies(data):
              proxies = data.get("proxies", [])
              clean = []
              for p in proxies:
                  if p.get("type") == "vless" and p.get("reality-opts"):
                      print(f"ğŸš« è¿‡æ»¤ reality èŠ‚ç‚¹ï¼š{p.get('name')}")
                      continue
                  clean.append(p)
              return clean

          merged_proxies = []
          for url in urls:
              content = download_yaml(url)
              merged_proxies += filter_proxies(content)

          output = {
              "proxies": merged_proxies,
              "proxy-groups": [
                  {
                      "name": "ğŸš€ è‡ªåŠ¨é€‰æ‹©",
                      "type": "url-test",
                      "proxies": [p["name"] for p in merged_proxies],
                      "url": "http://www.gstatic.com/generate_204",
                      "interval": 300
                  }
              ],
              "rules": ["MATCH,ğŸš€ è‡ªåŠ¨é€‰æ‹©"]
          }

          with open("merged.yaml", "w", encoding="utf-8") as f:
              yaml.dump(output, f, allow_unicode=True)

          print(f"âœ… å·²è¾“å‡º {len(merged_proxies)} ä¸ªèŠ‚ç‚¹ â†’ merged.yaml")
          EOF

          python3 filter_reality.py

      - name: Checkout ç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: å¤åˆ¶è¾“å‡ºå¹¶æäº¤åˆå¹¶æ–‡ä»¶
        run: |
          cp merged.yaml target-repo/merged.yaml
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add merged.yaml
          git commit -m "è‡ªåŠ¨è¿‡æ»¤ reality èŠ‚ç‚¹å¹¶æ›´æ–°è®¢é˜…" || echo "æ— å˜æ›´"
          git push
