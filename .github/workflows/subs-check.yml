name: V2Ray Subscription Checker

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  check-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        
      - name: Verify configuration
        run: |
          echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
          if [ ! -f "config/config.yaml" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ config/config.yaml"
            exit 1
          fi
          # ç¡®ä¿è¾“å‡ºç›®å½•è®¾ç½®æ­£ç¡®
          sed -i 's|output-dir:.*|output-dir: "/app/output"|' config/config.yaml
          echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨å¹¶å·²æ›´æ–°è¾“å‡ºç›®å½•"
        
      - name: Setup environment
        run: |
          echo "ğŸ›  å‡†å¤‡ç¯å¢ƒ..."
          mkdir -p output
          chmod -R 777 output
          chmod -R 777 config
          
      - name: Inspect Docker image
        run: |
          echo "ğŸ” æ£€æŸ¥ Docker é•œåƒç»“æ„..."
          # æŸ¥çœ‹é•œåƒçš„å…¥å£ç‚¹è®¾ç½®
          docker inspect --format='{{.Config.Entrypoint}}' ghcr.io/jackrun123/subs-check:latest
          
          # æŸ¥çœ‹é•œåƒçš„å‘½ä»¤è®¾ç½®
          docker inspect --format='{{.Config.Cmd}}' ghcr.io/jackrun123/subs-check:latest
          
          # æŸ¥çœ‹é•œåƒçš„æ–‡ä»¶ç»“æ„
          docker run --rm --entrypoint ls ghcr.io/jackrun123/subs-check:latest -l /app
          
      - name: Run subscription checker
        run: |
          echo "ğŸš€ å°è¯•è¿è¡Œè®¢é˜…æ£€æŸ¥å™¨..."
          
          # å°è¯•å¤šç§å¯èƒ½çš„å…¥å£ç‚¹ç»„åˆ
          ENTRYPOINTS=(
            "/app/subs-check"
            "/app/main"
            "/app/check"
            "/app/cli"
            ""
          )
          
          for entry in "${ENTRYPOINTS[@]}"; do
            echo "å°è¯•å…¥å£ç‚¹: ${entry:-<é»˜è®¤>}"
            
            # æ„å»ºDockerå‘½ä»¤
            cmd="docker run --rm \
              -v $PWD/config:/app/config \
              -v $PWD/output:/app/output"
            
            if [ -n "$entry" ]; then
              cmd+=" --entrypoint $entry"
            fi
            
            cmd+=" ghcr.io/jackrun123/subs-check:latest"
            
            if [ -n "$entry" ]; then
              cmd+=" -c /app/config/config.yaml"
            fi
            
            # è¿è¡Œå‘½ä»¤å¹¶æ•è·è¾“å‡º
            if $cmd 2>&1 | tee -a check.log; then
              echo "âœ… æ£€æŸ¥å™¨è¿è¡ŒæˆåŠŸ!"
              break
            else
              echo "âš  å°è¯•å¤±è´¥ï¼Œé”™è¯¯ä»£ç : $?"
            fi
          done
          
          # ç¡®ä¿è¾“å‡ºæ–‡ä»¶å­˜åœ¨
          if [ ! -f output/all.txt ]; then
            echo "âš  è­¦å‘Š: all.txt æœªç”Ÿæˆï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            touch output/all.txt
          fi
          
          echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶è¡Œæ•°: $(wc -l < output/all.txt)"
          
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          
      - name: Push results to target repository
        run: |
          echo "ğŸ“¤ æ¨é€ç»“æœåˆ°ç›®æ ‡ä»“åº“..."
          cp -v output/all.txt target-repo/all.txt
          
          cd target-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all.txt
          
          if git diff-index --quiet HEAD --; then
            echo "ğŸŸ¢ æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            NODE_COUNT=$(wc -l < all.txt)
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨ ($NODE_COUNT ä¸ªèŠ‚ç‚¹) $TIMESTAMP"
            git push
            echo "âœ… æäº¤æˆåŠŸ! æ¨é€äº† $NODE_COUNT ä¸ªèŠ‚ç‚¹"
          fi
          
      - name: Final verification
        run: |
          echo "ğŸ” æœ€ç»ˆéªŒè¯"
          if [ -f target-repo/all.txt ]; then
            NODE_COUNT=$(wc -l < target-repo/all.txt)
            echo "ğŸ“¦ æˆåŠŸæ¨é€ $NODE_COUNT ä¸ªèŠ‚ç‚¹"
            echo "æ–‡ä»¶å†…å®¹ç±»å‹:"
            file target-repo/all.txt
          else
            echo "âŒ é”™è¯¯: all.txt æœªæ‰¾åˆ°"
          fi
