name: V2Ray Subscription Checker

on:
  schedule:
    - cron: '0 */8 * * *'  # 每8小时运行一次
  workflow_dispatch:        # 允许手动触发

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # 拉取当前仓库（包含配置文件）
        
      - name: Verify config file
        run: |
          echo "检查配置文件..."
          if [ -f config/config.yaml ]; then
            echo "✅ 找到配置文件: config/config.yaml"
            echo "=== 配置文件行数 ==="
            wc -l config/config.yaml
          else
            echo "❌ 错误：未找到配置文件 config/config.yaml"
            exit 1
          fi
          
      - name: Prepare environment
        run: |
          # 创建输出目录
          mkdir -p output
          
          # 确保输出目录权限
          chmod -R 777 output
          
          echo "工作目录结构:"
          ls -al
          echo "配置文件内容摘要:"
          grep -E 'sub-urls:|output-dir:|concurrent:' config/config.yaml
          
      - name: Run subscription checker
        run: |
          echo "开始运行订阅检查器..."
          
          # 使用超时和错误忽略机制
          timeout 1h docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest \
            -c /app/config/config.yaml || true
          
          echo "容器运行完成"
          echo "=== 输出目录内容 ==="
          ls -al output
          
          # 确保输出文件存在
          if [ ! -f output/all.txt ]; then
            echo "⚠ 警告: all.txt 未生成，创建空文件"
            touch output/all.txt
          fi
          
          echo "有效节点数量: $(wc -l < output/all.txt)"
          
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          
      - name: Copy and commit results
        run: |
          echo "正在复制结果文件..."
          
          # 复制输出文件
          cp -v output/all.txt target-repo/all.txt
          
          cd target-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add all.txt
          
          if git diff-index --quiet HEAD --; then
            echo "没有变更，跳过提交"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            NODE_COUNT=$(wc -l < all.txt)
            git commit -m "自动更新节点列表 ($NODE_COUNT 个节点) $TIMESTAMP"
            git push
            echo "✅ 提交成功！"
          fi
          
      - name: Final verification
        run: |
          echo "=== 最终验证 ==="
          echo "目标仓库文件列表:"
          ls -al target-repo
          [ -f target-repo/all.txt ] && echo "节点数量: $(wc -l < target-repo/all.txt)" || echo "all.txt 不存在"
          echo "工作流执行完成"
