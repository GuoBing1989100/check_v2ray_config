name: Subscription Checker & Cleaner

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  check-clean-subscriptions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… Python æ¨¡å—
        run: pip install requests pyyaml

      - name: è¿‡æ»¤ reality èŠ‚ç‚¹ï¼Œç”Ÿæˆå¹²å‡€è®¢é˜…æ–‡ä»¶ï¼ˆå¸¦è°ƒè¯•è¾“å‡ºï¼‰
        run: |
          set -euo pipefail
          mkdir -p config
          cat <<'EOF' > filter.py
          import requests, yaml

          urls = [
              "https://raw.githubusercontent.com/firefoxmmx2/v2rayshare_subcription/main/subscription/clash_sub.yaml",
              "https://raw.githubusercontent.com/mahdibland/ShadowsocksAggregator/master/Eternity.yml",
              "https://raw.githubusercontent.com/ermaozi/get_subscribe/main/subscribe/clash.yml"
              # å¯ç»§ç»­æ·»åŠ æ›´å¤šè®¢é˜…é“¾æ¥
          ]

          def fetch(url):
              try:
                  print(f"ğŸ“¥ è·å–ï¼š{url}")
                  r = requests.get(url, timeout=10)
                  return yaml.safe_load(r.text) or {}
              except Exception as e:
                  print(f"âŒ è·³è¿‡: {url} -> {e}")
                  return {}

          def filter_nodes(data):
              proxies = data.get("proxies", []) or []
              return [p for p in proxies if not (p.get("type") == "vless" and p.get("reality-opts"))]

          proxies = []
          for u in urls:
              content = fetch(u)
              filtered = filter_nodes(content)
              if filtered:
                  print(f"âœ… ä» {u} å–å¾— {len(filtered)} ä¸ªå¹²å‡€èŠ‚ç‚¹")
              else:
                  print(f"âš ï¸ {u} æ²¡æœ‰ç•™ä¸‹å¹²å‡€èŠ‚ç‚¹")
              proxies += filtered

          with open("config/nodes.yaml", "w", encoding="utf-8") as f:
              yaml.dump({"proxies": proxies}, f, allow_unicode=True)

          print(f"âœ… æ€»å…±ä¿ç•™èŠ‚ç‚¹æ•°: {len(proxies)}ï¼Œå·²å†™å…¥ config/nodes.yaml")
          print("\n--- èŠ‚ç‚¹åç§°åˆ—è¡¨ï¼ˆå‰ 30ï¼‰---")
          for i, p in enumerate(proxies[:30]):
              name = p.get("name", "æœªå‘½å")
              t = p.get("type", "unknown")
              print(f"{i+1}. {name} - åè®®: {t}")
          EOF

          python3 filter.py

      - name: æŸ¥çœ‹ç”Ÿæˆçš„ config/nodes.yaml å†…å®¹ï¼ˆè°ƒè¯•ï¼‰
        run: |
          echo "----- nodes.yaml å†…å®¹ -----"
          if [ -f config/nodes.yaml ]; then
            cat config/nodes.yaml | head -n 200 || true
            echo "æ–‡ä»¶å¤§å°ï¼š"
            ls -lh config/nodes.yaml
          else
            echo "âŒ config/nodes.yaml ä¸å­˜åœ¨"
          fi

      - name: è®¾å®šæ˜¯å¦è·³è¿‡ subs-checkï¼ˆ`nodes.yaml` ç©ºåˆ¤æ–­ï¼‰
        id: check_nodes
        run: |
          if [ ! -s config/nodes.yaml ]; then
            echo "nodes_empty=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ config/nodes.yaml ä¸ºç©ºï¼Œå°†è·³è¿‡ subs-check ä½†ç»§ç»­åç»­æ­¥éª¤"
          else
            echo "nodes_empty=false" >> $GITHUB_OUTPUT
          fi

      - name: è¿è¡Œ subs-check æ£€æŸ¥å¹²å‡€çš„èŠ‚ç‚¹ï¼ˆå®¹å™¨å¤±è´¥ä¸ç»ˆæ­¢ï¼‰
        if: steps.check_nodes.outputs.nodes_empty == 'false'
        run: |
          mkdir -p output
          echo "ğŸ“¦ å¼€å§‹è¿è¡Œ subs-check å®¹å™¨"
          docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest
          ret=$?
          if [ $ret -ne 0 ]; then
            echo "âŒ subs-check é€€å‡ºç ï¼š$retï¼ˆå¤±è´¥ä½†ç»§ç»­ï¼‰"
          else
            echo "âœ… subs-check æˆåŠŸå®Œæˆ"
          fi

      - name: Checkout ç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: æ¨é€æ£€æµ‹ç»“æœ
        run: |
          cp -r output/* target-repo/ || echo "âš ï¸ output ç›®å½•å¯èƒ½ä¸ºç©ºï¼Œç»§ç»­æ‰§è¡Œ"
          cd target-repo
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add *.txt || true
          git commit -m "å®šæ—¶æ›´æ–°ï¼šsubs-check æ£€æµ‹é€šè¿‡èŠ‚ç‚¹" || echo "æ²¡æœ‰å˜æ›´"
          git push || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½† Job ä¸ä¼šå› ä¸ºè¿™ä¸ªå¤±è´¥ä¸­æ–­"
