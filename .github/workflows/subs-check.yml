name: Subscription Checker & Cleaner

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  check-clean-subscriptions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 当前仓库
        uses: actions/checkout@v4

      - name: 安装 Python 模块
        run: pip install requests pyyaml

      - name: 过滤 reality 节点，生成干净订阅文件
        run: |
          mkdir -p config
          cat << 'EOF' > filter.py
          import requests, yaml

          urls = [
              "https://raw.githubusercontent.com/firefoxmmx2/v2rayshare_subcription/main/subscription/clash_sub.yaml",
              "https://raw.githubusercontent.com/mahdibland/ShadowsocksAggregator/master/Eternity.yml",
              "https://raw.githubusercontent.com/ermaozi/get_subscribe/main/subscribe/clash.yml"
              # 可以添加更多订阅链接
          ]

          def fetch(url):
              try:
                  print(f"📥 获取：{url}")
                  r = requests.get(url, timeout=10)
                  return yaml.safe_load(r.text)
              except Exception as e:
                  print(f"❌ 跳过: {url} -> {e}")
                  return {}

          def filter_nodes(data):
              proxies = data.get("proxies", [])
              return [p for p in proxies if not (p.get("type") == "vless" and p.get("reality-opts"))]

          proxies = []
          for u in urls:
              content = fetch(u)
              proxies += filter_nodes(content)

          with open("config/nodes.yaml", "w", encoding="utf-8") as f:
              yaml.dump({"proxies": proxies}, f, allow_unicode=True)

          print(f"✅ 节点数: {len(proxies)}，已写入 config/nodes.yaml")
          EOF

          python3 filter.py

      - name: 运行 subs-check 检查干净的节点
        run: |
          mkdir -p output
          docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest

      - name: Checkout 目标仓库
        uses: actions/checkout@v4
        with:
          repository: GuoBing1989100/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: 推送检测结果
        run: |
          cp -r output/* target-repo/
          cd target-repo
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add *.txt
          git commit -m "定时更新：subs-check 检测通过节点" || echo "没有变更"
          git push
